<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title></title>
    <!-- <script src="statics/admin/js/jquery.min.js" type="text/javascript"></script> -->
    <link rel="stylesheet" href="statics/admin/css/datePicker.css">
    <!--  <link rel="stylesheet" href="statics/admin/css/pintuer.css"> -->
    <link rel="stylesheet" href="statics/admin/css/admin.css">
    <link rel="stylesheet" href="statics/admin/js/layer/2.1/skin/layer.css">
    <link rel="stylesheet" href="statics/admin/js/layer/2.1/skin/layer.ext.css">
    <script src="statics/admin/js/jquery.js"></script>
    <script src="statics/admin/js/layer/2.1/layer.js"></script>
    <script src="statics/admin/js/layer/2.1/extend/layer.ext.js"></script>
    <script src="statics/admin/js/pintuer.js"></script>
    <script src="statics/admin/bootstrap/js/bootstrap.min.js"></script>
    {template public-new-ui-header}
    <style type='text/css'>
        .rules-1{
            float: left;
            height: 35px;
            line-height: 35px;
            padding-right:10px;
        }
        .rules-2{
            float: left;
            height: 35px;
            line-height: 35px;
            padding:0 10px 0 10px;
        }
        .rules-3{
            float: left;
            width: 20%;
        }
    </style>
</head>
<body style="margin: 15px;background-color: #f3f3f4;">
<div class="ibox float-e-margins">
    <div class="ibox-title iboxWTitle">
        <h5>{if $type == 'rule'}飘窗规则设置{elseif $type == "config"}中奖飘窗配置{/if}</h5>
    </div>
    <div class="ibox-content bagCol">
        <div class="ibox-title">
            <h5>详情</h5>
            {if $type == 'rule'}
            <div class="ibox-tools">
                <a class="btn btn-white btn-bitbucket btn_sure" id="update" data-title="修改"><i class="fa fa-pencil"></i> </a>
                <a style="display: none" class="btn btn-white btn-bitbucket btn_sure" data-title="保存" id="btn_submit"><i class="fa fa-save"></i></a>
            </div>
            {/if}
        </div>
        <div class="ibox-content">
            <form method="get" class="form-horizontal">

                {if $type == 'rule'}

                <div class="form-group">
                    <div style="margin-left: 210px;">
                        <p><b>1.</b>以下规则按照每个会员在单期单个彩种单个房间中奖金额计算进行推送提醒；</p>
                        <p><b>2.</b>一鸣惊人 金额必须大于【大显身手】的中奖金额；</p>
                        <p><b>3.</b>手气逆天 金额必须大于【一鸣惊人】的中奖金额；</p>
                        <p><b>4.</b>中奖金额必须为大于0的整数；</p>
                        <p><b>5.</b>起始金额必须大于结束金额；</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label">大显身手</label>
                    <div class="col-sm-7 barrage_config">
                        <input type="hidden" name="name" value="大显身手" />
                        <span class="rules-1">中奖金额为</span>
                        <input disabled="disabled" type="number" class="form-control rules-3" name="start_money" value="{if $config[0] == '' }10000{else}{$config[0]['start_money']}{/if}" />
                        <span class="rules-2">至</span>
                        <input disabled="disabled" type="text" class="form-control rules-3" name="end_money" value="{if $config[0] == '' }20000{else}{$config[0]['end_money']}{/if}" />
                        <span class="rules-2">之间的元宝</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label">一鸣惊人</label>
                    <div class="col-sm-7 barrage_config">
                        <input type="hidden" name="name" value="一鸣惊人" />
                        <span class="rules-1">中奖金额为</span>
                        <input disabled="disabled" type="text" class="form-control rules-3" name="start_money" value="{if $config[1] == '' }20001{else}{$config[1]['start_money']}{/if}" />
                        <span class="rules-2">至</span>
                        <input disabled="disabled" type="text" class="form-control rules-3" name="end_money" value="{if $config[1] == '' }50000{else}{$config[1]['end_money']}{/if}" />
                        <span class="rules-2">之间的元宝</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label">手气逆天</label>
                    <div class="col-sm-7 barrage_config">
                        <input type="hidden" name="name" value="手气逆天" />
                        <span class="rules-1">中奖金额为</span>
                        <input disabled="disabled" type="text" class="form-control rules-3" name="start_money" value="{if $config[2] == '' }50001{else}{$config[2]['start_money']}{/if}" />
                        <span class="rules-2">至</span>
                        <input disabled="disabled" type="text" class="form-control rules-3" name="end_money" value="{if $config[2] == '' }80000{else}{$config[2]['end_money']}{/if}" />
                        <span class="rules-2">之间的元宝</span>
                    </div>
                </div>


                {elseif $type == "config"}

                <div class="form-group">
                    <label class="col-sm-2 control-label">选择时间段</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control rules-3" id="start_time" value="{$data['value']['start_time']}" />
                        <span class="rules-2">-</span>
                        <input type="text" class="form-control rules-3" id="end_time" value="{$data['value']['end_time']}" />
                    </div>
                </div>


                <div class="form-group">
                    <label class="col-sm-2 control-label">提醒类型</label>
                    <div class="col-sm-3">
                        {if $config == ''}
                        <a href="?m=admin&c=activity&a=barrageSet&type=rule">请添加提醒类型配置</a>
                        {else}
                        <select class="form-control" id="barrage_type">
                            {loop $config $v}
                            <option value="{$v['name']}" {if $data['value']['barrage_type']['name'] == $v['name']} selected {/if} data-start-money="{$v['start_money']}" data-end-money="{$v['end_money']}">{$v['name']}</option>
                            {/loop}
                        </select>
                        {/if}
                    </div>
                </div>

                {if $config != ''}
                <div class="form-group">
                    <label class="col-sm-2 control-label">中奖金额范围</label>
                    <div class="col-sm-7 money">
                        <input type="text" class="form-control rules-3" id="start_money" readonly="readonly" />
                        <span class="rules-2">-</span>
                        <input type="text" class="form-control rules-3" id="end_money" readonly="readonly" />
                    </div>
                </div>
                {/if}

                <div class="form-group">
                    <label class="col-sm-2 control-label">选择机器人</label>
                    <div class="col-sm-3 money">
                        {if $list == ''}
                        <a href="?m=admin&c=role&a=dummyList">暂无机器人，请添加</a>
                        {else}
                        <a href="javascript:void(0)" class="set_user" style="line-height: 33px;color: #0099ff;">设置机器人</a>&nbsp;&nbsp;&nbsp;&nbsp;
                        已选择机器人:【<span id="user_num">0</span>】
                        {/if}
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label">每人推送条数</label>
                    <div class="col-sm-3 money">
                        <input type="text" class="form-control" id="num" value="{$data['value']['num']}" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label">选择彩种</label>
                    <div class="col-sm-3 money">
                        <select class="form-control" id="lottery-type">
                            {loop $lottery_list $k $v}
                            <option value="{$k}" {if $data['value']['lottery_type'] == $k} selected {/if}>{$v}</option>
                            {/loop}
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-2 control-label">选择玩法</label>
                    <div class="col-sm-3 money">
                        <a href="javascript:void(0)" class="set_way" style="line-height: 33px;color: #0099ff;">设置玩法</a>&nbsp;&nbsp;&nbsp;&nbsp;
                        已选择玩法:【<span id="way_num">0</span>】
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label"></label>
                    <div class="col-sm-2 col-sm-offset-1">
                        <button class="btn btn-primary" type="button" id="btn_submit">保存内容</button>
                        <button class="btn btn-white" type="button" style="border: 1px solid #e7eaec" onclick="javascript:history.go(-1);" id="qx_submit">取消</button>
                    </div>
                </div>

                {/if}


            </form>
        </div>
    </div>
</div>

<div id="set_user" style="display: none">
    <div style="height: 284px; overflow: auto;">
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <th><input type="checkbox" onclick="selectAll(this,1)" /></th>
                <th>ID</th>
                <th>用户名</th>
                <th>昵称</th>
            </tr>
            </thead>
            <tbody>
            {loop $list $v}
            <tr>
                <td>
                    <input type='checkbox' class='check_box_user' data-id='{$v["id"]}' data-nickname='{$v["nickname"]}' data-avatar='{$v["avatar"]}' {if $data['value']['user_info'] != ''}checked{/if} />
                </td>
                <td>{$v["id"]}</td>
                <td>{$v["username"]}</td>
                <td>{$v["nickname"]}</td>
            </tr>
            {/loop}
            </tbody>
        </table>
    </div>

    <div style="margin:10px auto;width: 50%">
        <input type='submit' value='确定' class='btn btn-block btn-outline btn-primary' onclick='setTableUer()' />
    </div>
</div>

<div id="set_way" style="display: none">
    <div style="height: 284px; overflow: auto;">
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <th><input type="checkbox" onclick="selectAll(this,2)" /></th>
                <th>玩法名称</th>
            </tr>
            </thead>
            <tbody id="set_way_body">
            </tbody>
        </table>
    </div>
    <div style="margin:10px auto;width: 50%">
        <input type='submit' value='确定' class='btn btn-block btn-outline btn-primary' onclick='setTableWay()' />
    </div>
</div>

<script type="text/javascript">
    var loading = "";//加载中......
    var index = "";


    $("#update").click(function(){
        $("#btn_submit").show();
        $(this).remove();
        $("input").attr("disabled",false);
    })

    $(function(){
        $("#barrage_type").change();
        $("#lottery-type").change();
        setTableUer();
    });

    function setTableUer(){
        $("#user_num").text($("#set_user").find(".check_box_user:checked").length);
        layer.close(index)
    }

    function setTableWay(){
        $("#way_num").text($("#set_way").find(".check_box_way:checked").length);
        layer.close(index)
    }


    //机器人全选
    function selectAll(obj,type) {
        if($(obj).prop("checked")) {
            if (type == 1) {
                $(".check_box_user").prop("checked",true);
            } else if(type == 2) {
                $(".check_box_way").prop("checked",true);
            }
        } else {
            if (type == 1) {
                $(".check_box_user").prop("checked",false);
            } else if(type == 2) {
                $(".check_box_way").prop("checked",false);
            }
        }
    }

    $(".set_way").click(function(){
        title ="玩法列表";
        dome = $("#set_way");
        index = layer.open({
            type: 1,
            title:title,
            skin: 'layui-layer-demo', //样式类名
            area: ['630px', '380px'],
            anim: 2,
            shadeClose: true, //开启遮罩关闭
            content:dome
        });
    })



    $(".set_user").click(function(){
        title ="机器人列表";
        dome = $("#set_user");
        index = layer.open({
            type: 1,
            title:title,
            skin: 'layui-layer-demo', //样式类名
            area: ['630px', '380px'],
            anim: 2,
            shadeClose: true, //开启遮罩关闭
            content:dome
        });
    })



    $("#lottery-type").change(function(){
        $("#set_way_body").empty();
        var html = '';
        var way_info = JSON.parse('<?php echo json_encode($way_info,JSON_UNESCAPED_UNICODE);  ?>');
        var way = JSON.parse('<?php echo json_encode($data["value"]["way"],JSON_UNESCAPED_UNICODE);  ?>');
        var id = $(this).val();
        for (var a = 0; a < way_info[id].length; a++) {
            var checked = "";
            if (way != null) {
                for (var b = 0; b < way.length; b++) {
                    if (way_info[id][a] == way[b]) {
                        checked = "checked";
                        way.splice($.inArray(way[b], way), 1);
                        continue;
                    }
                }
            }
            html += "<tr><td>";
            html += "<input type='checkbox' class='check_box_way'  "+checked+"  data-way='"+way_info[id][a]+"' />"
            html += "</td><td>"+way_info[id][a]+"</td></tr>";
        }
        $("#set_way_body").html(html);
        setTableWay();
    });

    $("#barrage_type").change(function(){
        $("#start_money").val($(this).find("option:selected").attr("data-start-money"))
        $("#end_money").val($(this).find("option:selected").attr("data-end-money"))
    })

    $("#btn_submit").click(function(){
        if ("{$type}" == "rule"){
            var reg = /^[1-9]\d*$/;
            var config = []
            var demo = $(".barrage_config");
            for (var a = 0; a < demo.length; a++) {
                var obj = $(demo[a]);
                var tmp = {
                    'start_money':obj.find("input[name='start_money']").val(),
                    'end_money':obj.find("input[name='end_money']").val(),
                    'name':obj.find("input[name='name']").val(),
                };
                tmp.start_money = parseInt(tmp.start_money);
                tmp.end_money = parseInt(tmp.end_money);
                if(!reg.test(tmp.start_money) || !reg.test(tmp.end_money)) {
                    layer.alert('中奖金额只能为大于0的数字！', {icon: 5, shade: [0.5, '#393D49']});
                    return false;
                }
                if(!reg.test(tmp.start_money) || !reg.test(tmp.end_money)) {
                    layer.alert('中奖金额只能为大于0的数字！', {icon: 5, shade: [0.5, '#393D49']});
                    return false;
                }
                if(tmp.start_money <= 0 || tmp.end_money <= 0  || tmp.start_money > tmp.end_money){
                    layer.alert('金额设置不正确请重试!', {icon: 5, shade: [0.5, '#393D49']});
                    return false;
                }
                config.push(tmp);
            }
            for (var a = 0; a < config.length; a++) {
                for (var b = a + 1; b < config.length; b++) {
                    if (config[b].start_money <= config[a].end_money) {
                        layer.alert('【'+ config[b].name +'】起始金额必须大于【'+ config[a].name +'】结束金额', {icon: 5, shade: [0.5, '#393D49']});
                        return false;
                    }
                }
            }
            var data = {
                'type':"{$type}",
                'config':config,
            }
        } else if("{$type}" == "config") {
            var reg = /^[0-9]\d*$/;
            var value = {
                'start_time':parseInt($("#start_time").val()),
                'end_time':parseInt($("#end_time").val()),
                'barrage_type':{
                    'name':$("#barrage_type option:selected").val(),
                    'start_money':$("#start_money").val(),
                    'end_money':$("#end_money").val(),
                },
                'lottery_type':$("#lottery-type").val(),
                'user_info':[],
                'num':parseInt($("#num").val()),
                'way':[],
            }
			if(!reg.test(value.start_time) || !reg.test(value.end_time) || value.start_time > 24 || value.end_time > 24 || value.start_time < 0 || value.end_time < 0) {
				layer.alert('时间段只能是0-24之间的整数', {icon: 5, shade: [0.5, '#393D49']});
                return false;
			}
			if(value.start_time > value.end_time) {
				layer.alert('开始时间不能大于结束时间', {icon: 5, shade: [0.5, '#393D49']});
                return false;
			}
            
            if (!reg.test(value.num) && value.num <= 0) {
                layer.alert('推送条数必须为大于0的整数', {icon: 5, shade: [0.5, '#393D49']});
                return false;
            }

            if (value.start_time === '' || value.end_time === '' || value.start_time == value.end_time) {
                layer.alert('时间段不能为空并且开始与结束时间不能相同', {icon: 5, shade: [0.5, '#393D49']});
                return false;
            }
            for (var a = 0; a < $(".check_box_user:checked").length; a++) {
                var user_tmp = {
                    'user_id': $(".check_box_user:checked").eq(a).attr("data-id"),
                    'nickname': $(".check_box_user:checked").eq(a).attr("data-nickname"),
                    'avatar': $(".check_box_user:checked").eq(a).attr("data-avatar")
                };
                value.user_info.push(user_tmp);
            }
            if (value.user_info.length == 0) {
                layer.alert('请选择机器人', {icon: 5, shade: [0.5, '#393D49']});
                return false;
            }
            for (var a = 0; a < $(".check_box_way:checked").length; a++) {
                value.way.push($(".check_box_way:checked").eq(a).attr("data-way"));
            }
            if (value.way.length == 0) {
                layer.alert('请选择玩法', {icon: 5, shade: [0.5, '#393D49']});
                return false;
            }
            var check_num = parseInt((value.end_time - value.start_time) * value.user_info.length * 500);
            if (value.num > check_num) {
                layer.alert('每人推送条数不能大于' + check_num, {icon: 5, shade: [0.5, '#393D49']});
                return false;
            }
            if (value.num == "" || isNaN(value.num)) {
                layer.alert('请填写推送条数', {icon: 5, shade: [0.5, '#393D49']});
                return false;
            }
            if (value.barrage_type.name == '' || value.barrage_type.start_money == '' || value.barrage_type.end_money == '') {
                layer.alert('请选择提醒类型', {icon: 5, shade: [0.5, '#393D49']});
                return false;
            }
            var data = {
                'type':"{$type}",
                'value':value,
                'id':'{$id}'
            }
        }
        $.ajax({
            url: "?m=admin&c=activity&a=barrageAct",
            data: data,
            dataType: 'json',
            type: 'post',
            beforeSend: function () {
                loading = layer.load(1);
            },
            error: function () {
                layer.close(loading);
                layer.msg('网络错误！！！', {icon: 5, shade: [0.5, '#393D49']});
            },
            success: function (data) {
                layer.close(loading);
                if(data['code'] != 0) {
                    layer.msg(data['msg'], {icon: 5, shade: [0.5, '#393D49']}, function () {
                        return false;
                    });
                } else {
                    layer.msg(data['msg'], {icon: 6, shade: [0.5, '#393D49']}, function () {
                        if ("{$type}" == "config") {
                            location.href = '?m=admin&c=activity&a=barrageConfigList';
                        } else {
                            window.location.reload();
                        }

                    });
                }

            }
        });

    })
</script>
</body>
</html>