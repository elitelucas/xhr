<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title></title>
    <!-- <script src="statics/admin/js/jquery.min.js" type="text/javascript"></script> -->
    <link rel="stylesheet" href="statics/admin/css/datePicker.css">
    <!--  <link rel="stylesheet" href="statics/admin/css/pintuer.css"> -->
    <link rel="stylesheet" href="statics/admin/css/admin.css">
    <link rel="stylesheet" href="statics/admin/js/layer/2.1/skin/layer.css">
    <link rel="stylesheet" href="statics/admin/js/layer/2.1/skin/layer.ext.css">
    <script src="statics/admin/js/jquery.js"></script>
    <script src="statics/admin/js/layer/2.1/layer.js"></script>
    <script src="statics/admin/js/layer/2.1/extend/layer.ext.js"></script>
    <script src="statics/admin/js/pintuer.js"></script>
    <script src="statics/admin/bootstrap/js/bootstrap.min.js"></script>

    <!-- template-begin+++ -->
    {template public-new-ui-header}
    <!-- template-end+++ -->
    <script src="statics/admin/js/jquery.date_input.pack.js"></script>
    <link rel="stylesheet" href="statics/admin/jedate/skin/jedate.css">
    <script type="text/javascript" src="statics/admin/jedate/jquery.jedate.min.js"></script>

    <!-- 图片上传 引入插件 -->
    <script src="statics/admin/fileupload/js/vendor/jquery.ui.widget.js"></script>
    <script src="statics/admin/fileupload/js/jquery.fileupload.js"></script>

    <style type='text/css'>
        #page{height: 60px;margin-top: 20px;text-align: center;}
        #page ul li{float: left;margin-right:10px;}
        #page ul .current{ background-color:#0099ff;text-align:center;}
        .table td div.username{
            height: 23px;
            overflow: hidden;
            white-space:nowrap;
            text-overflow: ellipsis;
        }
        .table tbody tr td{
            vertical-align: middle;
        }
        .table>thead>tr>th {
            vertical-align: middle;
        }
        .rules-1{
            float: left;
            height: 35px;
            line-height: 35px;
            padding-right:10px;
        }
        .rules-2{
            float: left;
            height: 35px;
            line-height: 35px;
            padding:0 10px 0 10px;
        }
        .rules-3{
            float: left;
            width: 20%;
        }
    </style>
</head>
<body style="margin: 15px;background-color: #f3f3f4;">
<div class="ibox float-e-margins">
    <div class="ibox-title iboxWTitle">
        <h5>新增活动</h5>
        <div class="ibox-tools">
            <a href="javascript:void(0)" class="btn btn-white btn-bitbucket" onclick="javascript:history.go(-1);">
                <i class="fa fa-reply"></i> 返回
            </a>
        </div>
    </div>
    <div class="ibox-content bagCol">
        <div class="ibox-title">
            <h5>活动详情</h5>
        </div>
        <div class="ibox-content">
            <form method="get" class="form-horizontal">

                <div class="form-group">
                    <div style="margin-left: 25px;">
                        <p><b>元宝数额一栏说明：</b>如果为实物，该选项为：0；如果为元宝，该选项为：具体数值</p>
                        <p><b>白名单一栏说明：</b>输入格式为：用户名-中奖次数 多个用户请用英文分号“;”分开，例如：admin-1;user-2.....</p>
                        <p><b>中奖率一栏说明：</b>所有序号内对应层级中奖率相加必须为100%</p>
                        <p><b>奖品设置说明：</b>转盘背景图片的第一片扇叶均为“谢谢参与”，建议将第一个奖品设置为“谢谢参与”</p>
                        <p><b>奖品名称限制说明：</b>奖品名称一列最多能输入10个字符</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">活动名称</label>
                    <div class="col-sm-4">
                        <input type="text" class="form-control" name="act-activity_title" placeholder="活动名称只能输入字母，数字，下划线以及中文并且长度2-15个字符" value="{$activity_info['activity_title']}" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">活动时间</label>
                    <div class="col-sm-7">
                        <div class="input-group">
                            <input style="width: 43%" type="text" name="act-start_time" class="date_picker form-control start_time" value="{$s_date}" />
                            <span style="float: left;line-height: 34px;padding: 0 20px 0 20px;">至</span>
                            <input style="width: 43%" type="text" name="act-end_time" class="date_picker form-control end_time" value="{$e_date}" />
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">是否开启</label>
                    <div class="col-sm-1">
                        <select class="form-control m-b" name="act-is_underway">
                            <option value="0" {if $activity_info['is_underway'] == 0} selected="selected" {/if}>未开启</option>
                            <option value="1" {if $activity_info['is_underway'] == 1} selected="selected" {/if}>开启</option>
                            <option value="2" {if $activity_info['is_underway'] == 2} selected="selected" {/if}>停止</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">玩法规则</label>
                    <div class="col-sm-7">
                        <span class="rules-1">每充值达到</span>
                        <input class="form-control rules-3 rules" data-key="every_topup" value="{$activity_rules_data['every_topup']}" type="text" />
                        <span class="rules-2">元宝，可以玩</span>
                        <input class="form-control rules-3 rules" data-key="every_topup_val" value="{$activity_rules_data['every_topup_val']}" type="text" />
                        <span class="rules-2">次</span>

                        <br /><br />

                        <span class="rules-1">每投注达到</span>
                        <input class="form-control rules-3 rules" data-key="every_bet" value="{$activity_rules_data['every_bet']}" type="text" />
                        <span class="rules-2">元宝，可以玩</span>
                        <input class="form-control rules-3 rules" data-key="every_bet_val" value="{$activity_rules_data['every_bet_val']}" type="text" />
                        <span class="rules-2">次</span>

                        <br /><br />

                        <span class="rules-1">每赢达到</span>
                        <input class="form-control rules-3 rules" data-key="every_win" value="{$activity_rules_data['every_win']}" type="text" />
                        <span class="rules-2">元宝，可以玩</span>
                        <input class="form-control rules-3 rules" data-key="every_win_val" value="{$activity_rules_data['every_win_val']}" type="text" />
                        <span class="rules-2">次</span>

                        <br /><br />

                        <span class="rules-1">每输达到</span>
                        <input class="form-control rules-3 rules" data-key="every_lose" value="{$activity_rules_data['every_lose']}" type="text">
                        <span class="rules-2">元宝，可以玩</span>
                        <input class="form-control rules-3 rules" data-key="every_lose_val" value="{$activity_rules_data['every_lose_val']}" type="text">
                        <span class="rules-2">次</span>

                    </div>
                    <textarea style="display:none;" name="act-rules_json">{$activity_info['rules_json']}</textarea>
                    <input type="hidden" class="rules" data-key="rules_type" value="{$activity_rules_data['rules_type']}">
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">会员组</label>
                    <div class="col-sm-10">
                        <label class="checkbox-inline"><input type="checkbox" class="group_check_all">全部</label>
                        {loop $group_info_arr $group_val}
                        <label class="checkbox-inline">
                            <input name="user_group_limit" type="checkbox" class="group_check" value="{$group_val['id']}" {if in_array($group_val['id'], $user_group_limit_arr)} checked="checked" {/if}>{$group_val['name']}
                        </label>
                        {/loop}
                        <input type="hidden" name="act-user_group_limit" value="{$activity_info['user_group_limit']}">
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">转盘格数</label>
                    <div class="col-sm-1">
                        {if $view_type == '2' || $view_type == '3'}
                        <label class="checkbox-inline">{$activity_info['turn_num']}格</label>
                        {else}
                        <select name="turn_num" class="form-control select_turn_num">
                            {loop $turn_num_arr $each_turn_num}
                            <option value="{$each_turn_num}" {if $each_turn_num == $activity_info['turn_num']} selected="selected" {/if}>{$each_turn_num}格</option>
                            {/loop}
                        </select>
                        {/if}
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">转盘图片</label>
                    <div class="col-sm-4">
                        {if $view_type == '2' || $view_type == '3'}
                        <img src="{$activity_info['turn_pic']}" alt="" style="width:150px; height:150px;">
                        {else}
                        <img src="/up_files/turntable/wheel_pic/4_num.png" alt="" style="width:150px; height:150px;display:inline;" data-img-key="4">
                        <img src="/up_files/turntable/wheel_pic/8_num.png" alt="" style="width:150px; height:150px;display:none;" data-img-key="8">
                        <img src="/up_files/turntable/wheel_pic/10_num.png" alt="" style="width:150px; height:150px;display:none;" data-img-key="10">
                        <img src="/up_files/turntable/wheel_pic/12_num.png" alt="" style="width:150px; height:150px;display:none;" data-img-key="12">
                        {/if}
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">活动详情</label>
                    <div class="col-sm-5">
                        <textarea class="form-control" name="act-activity_details" rows="5">{$activity_info['activity_details']}</textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">活动声明</label>
                    <div class="col-sm-5">
                        <textarea class="form-control" name="act-activity_statement" rows="5">{$activity_info['activity_statement']}</textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-1 control-label">奖品设置</label>
                    <div class="col-sm-11">
                        <div class="dataTables_wrapper form-inline">
                            <table class="table table-striped table-bordered table-hover  dataTable" id="editable" aria-describedby="editable_info">
                                <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>奖品类型</th>
                                    <th>奖品名称</th>
                                    <th>图片</th>
                                    <th>元宝数额</th>
                                    <th>奖品份数</th>
                                    <th>剩余奖品份数</th>
                                    <th>中奖白名单</th>
                                    <th>中奖率(%)</th>
                                </tr>
                                </thead>
                                <tbody>
                                {if $view_type == '2' || $view_type == '3'}
                                <tbody class="{$activity_info['turn_num']}-prize-body prize_setting_tb">
                                {loop $prize_setting_data $kk $vv}
                                <tr data-index="{$kk}">
                                    <td><input data-name="id" data-prize-flag="1" data-index="{$kk}" type="text" value="<?php echo $kk + 1;?>" style="width: 50px;" class="form-control" readonly="readonly" /></td>
                                    <td>
                                        <select data-name="prize_type" data-prize-flag="1" data-index="{$kk}"class="form-control">
                                            <option value="1" {if $vv['prize_type'] == 1} selected="selected" {/if} data-empty-yuanbao="1">实物</option>
                                            <option value="2" {if $vv['prize_type'] == 2} selected="selected" {/if}>元宝</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input data-name="name" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['name']}" class="form-control" maxlength="10" data-award-tips="{$content_in_pic_arr[$kk]}"/>
                                        <span style="color: grey;">此项为转盘中的“{$content_in_pic_arr[$kk]}”</span>
                                    </td>
                                    <td>
                                        {if $view_type == '2'}
                                        <!-- 编辑时，需要上传图片 -->
                                        <img data-index="{$kk}" class="view" src="{$vv['img']}" alt="" style="float: left;width:120px; height: 120px; {if !$vv['img']}display:none;{/if}" onclick="this.nextElementSibling.click();">
                                        <input data-index="{$kk}" style="display:none;" name="file" class="file_upload" type="file">
                                        <a href="javascript:;" onclick="this.previousElementSibling.click();">上传图片</a>
                                        <input data-name="img" data-prize-flag="1" data-index="{$kk}" name="url" id="url" value="{$vv['img']}" type="hidden">
                                        {else}
                                        <!-- 查看时，不需要上传图片 -->
                                        {if $vv['img']}
                                        <img data-index="{$kk}" class="view" src="{$vv['img']}" alt="" style="float: left;width:120px; height: 120px; ">
                                        {else}
                                        <span>未上传图片</span>
                                        {/if}
                                        {/if}
                                    </td>

                                    <td><input data-name="num" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['num']}" title="如果为实物，该选项为：0；如果为元宝，该选项为：具体数值" style="width: 100px" class="form-control check_prize_type_input" /></td>
                                    <!-- <td>
                                        <select data-name="is_prizes" data-prize-flag="1" data-index="{$kk}" class="input">
                                            <option value="1" {if $vv['is_prizes'] == 1} selected="selected" {/if} data-empty-yuanbao="1">是</option>
                                            <option value="2" {if $vv['is_prizes'] == 2} selected="selected" {/if}>否</option>
                                        </select>
                                    </td> -->
                                    <td><input data-name="prize_num" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['prize_num']}" style="width: 100px" class="form-control positive_val" /></td>
                                    <td><input data-name="rest_prize_num" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['rest_prize_num']}" style="width: 100px" class="form-control positive_val" /></td>
                                    <td><input data-name="white_list" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['white_list']}" class="form-control" /></td>
                                    <td>
                                        <input type="text" data-name="probability" data-prize-flag="1" data-index="{$kk}" data-user-group="{$vv['id']}" data-group-name="{$vv['probability']}" value="{$vv['probability']}" class="form-control rate_num" />
                                    </td>
                                </tr>
                                {/loop}
                                </tbody>
                                {else}
                                {loop $turn_num_arr $each_turn_num2}
                                <tbody class="{$each_turn_num2}-prize-body prize_setting_tb" style="display:none;">
                                <!--  -->
                                <?php
                                            $default_arr = array_fill(0, $each_turn_num2, []);
                                        ?>
                                {loop $default_arr $kk $vv}
                                <tr data-index="{$kk}">
                                    <td><input data-name="id" data-prize-flag="1" data-index="{$kk}" type="text" value="<?php echo $kk + 1;?>" class="form-control" readonly="readonly"/></td>
                                    <td>
                                        <select data-name="prize_type" data-prize-flag="1" data-index="{$kk}"class="form-control">
                                            <option value="1" {if $vv['prize_type'] == 1} selected="selected" {/if} data-empty-yuanbao="1">实物</option>
                                            <option value="2" {if $vv['prize_type'] == 2} selected="selected" {/if}>元宝</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input data-name="name" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['name']}" class="form-control" maxlength="10"/>
                                        <span style="color: grey;">此项为转盘中的“{$content_in_pic_arr[$kk]}”</span>
                                    </td>
                                    <td>
                                        <!--  -->
                                        <!--  -->
                                        <img data-index="{$kk}" class="view" src="{$vv['img']}" alt="" style="float: left;width:120px; height: 120px; {if !$vv['img']}display:none;{/if}" onclick="this.nextElementSibling.click();">
                                        <input data-index="{$kk}" style="display:none;" name="file" class="file_upload" type="file">
                                        <a href="javascript:;" onclick="this.previousElementSibling.click();">上传图片</a>
                                        <input data-name="img" data-prize-flag="1" data-index="{$kk}" name="url" id="url" value="{$vv['img']}" type="hidden">
                                        <!-- <input name="flag" id="flag" value="1" type="hidden"></td> -->
                                        <!--  -->
                                        <!--  -->
                                    </td>

                                    <td><input data-name="num" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['num']}" title="如果为实物，该选项为：0；如果为元宝，该选项为：具体数值" style="width: 100px" class="form-control check_prize_type_input" /></td>
                                    <!-- <td>
                                        <select data-name="is_prizes" data-prize-flag="1" data-index="{$kk}" class="input">
                                            <option value="1" {if $vv['is_prizes'] == 1} selected="selected" {/if} data-empty-yuanbao="1">是</option>
                                            <option value="2" {if $vv['is_prizes'] == 2} selected="selected" {/if}>否</option>
                                        </select>
                                    </td> -->
                                    <td><input data-name="prize_num" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['prize_num']}" style="width: 100px" class="form-control positive_val" /></td>
                                    <td><input data-name="rest_prize_num" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['rest_prize_num']}" style="width: 100px" class="form-control positive_val" /></td>
                                    <td><input data-name="white_list" data-prize-flag="1" data-index="{$kk}" type="text" value="{$vv['white_list']}" class="form-control" /></td>
                                    <td>
                                        <input type="text" data-name="probability" data-prize-flag="1" data-index="{$kk}" data-user-group="{$vv['id']}" data-group-name="{$vv['probability']}" value="{$vv['probability']}" class="form-control rate_num" />
                                    </td>
                                </tr>
                                {/loop}
                                </tbody>
                                {/loop}
                                {/if}
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>


                <div class="form-group">
                    <div class="col-sm-2 col-sm-offset-1">
                        {if $activity_info['is_underway'] == '0' || $activity_info['is_underway'] == ''}
                        <button class="btn btn-primary" type="button" data-id="{$activity_info['id']}" id="btn_submit">保存内容</button>
                        {/if}
                        <button class="btn btn-white" type="button" style="border: 1px solid #e7eaec" onclick="javascript:history.go(-1);" id="qx_submit">取消</button>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript">
    $(function () {

        //初始化时，将未选中的活动规则置为不可用
        $('.disabled_box').find(':text').each(function () {
            $(this).prop('disabled', true);
        });

        //活动规则切换
        $('[name="rd_rules_type"]').change(function () {
            var $this = $(this);
            var $rules_setting = $this.parent().parent().parent();
            $rules_setting
                .find(':text')
                .each(function () {
                    $(this).prop('disabled', false);
                })
                .end()
                .siblings('.rules_setting')
                .find(':text')
                .each(function () {
                    $(this).prop('disabled', true);
                });
            $('[data-key="rules_type"]').val($this.val());
        });

        //上传图片
        $(".file_upload").fileupload({
            url: "?m=admin&c=turntable&a=uploadImg",
            sequentialUploads: true
        }).bind('fileuploaddone', function(e, data) {
            // console.log($(this).data('index'));
            // console.log(data);

            var data_index = $(this).data('index');

            var res = $.parseJSON(data.result);

            if (res.status == 0) {
                $(".view[data-index='" + data_index + "']").attr({
                    'src': res.data
                }).show();
                $(".file_upload[data-index='" + data_index + "']").attr({
                    'style': "width:120px; height:120px; float: left; opacity: 0 ; margin-left: -120px"
                });
                $('input[data-name="img"][data-index="' + data_index + '"]').val(res.data);
            } else {
                layer.msg(res.data,{icon:5, shade: [0.5, '#393D49']}); //弹出错误信息
                return false;
            }
        });

        //全选初始化选中/未选中
        if ($('.group_check').not(':checked').length == 0) {
            $('.group_check_all').prop('checked', true);
        } else {
            $('.group_check_all').prop('checked', false);
        }

        //时间插件
        $(".date_picker").jeDate({
            isinitVal:true,
            festival:true,
            ishmsVal:true,
            // minDate: '2016-06-16 23:59:59',
            // maxDate: $.nowDate(0),
            format:"YYYY-MM-DD hh:mm:ss",
            zIndex:3000,
        });

        //显示第一个表格
        $('.prize_setting_tb:eq(0)').show();

        //添加时选择转盘图片
        $('.select_turn_num').change(function () {
            var img_key = $(this).val();
            //切换背景图
            $('[data-img-key]').hide();
            $('[data-img-key="' + img_key + '"]').show();

            //切换表格体
            $('.prize_setting_tb').hide();
            $('.' + img_key + '-prize-body').show();
        });

        //全选
        $('.group_check_all').change(function () {
            var group_check_val = $(this).prop('checked');
            $(this).parent().parent().find('.group_check').each(function () {
                $(this).prop('checked', group_check_val);
            });
        });

        // //如果选择的是奖品类的，则奖励的元宝数额一项的值自动变为0
        // // $('[data-name="prize_type"]:visible,[data-name="is_prizes"]:visible').change(function () {
        // $('[data-name="prize_type"]:visible').change(function () {
        //     var val = $(this).find(':selected').val();
        //     var txt = $(this).find(':selected').text();
        // });

        //保存
        $('#btn_submit').click(function () {
            //判断时间是否合法
            if (new Date($('.start_time').val()) > new Date($('.end_time').val())) {
                layer.msg('活动开始时间不能大于结束时间！', {icon: 5, shade: [0.5, '#393D49'], time:1200});
                return false;
            }

            //判断奖品类型和元宝数额是否能对应上
            var check_prize_type_rightful = true;
            $('[data-name="prize_type"]:visible').each(function () {
                var val = $(this).find(':selected').val();
                var yuanbao_val = $(this).parent().parent().find('.check_prize_type_input').val();
                //实物的元宝数值必须为0，或者元宝的元宝数值必须不为0
                if ((val == '1' && yuanbao_val > 0) || (val == '2' && yuanbao_val == '0')) {
                    check_prize_type_rightful = false;
                }
            });
            if (! check_prize_type_rightful) {
                layer.alert('奖品类型中，实物的元宝数值必须为0，或者元宝的元宝数值必须不为0！', {icon: 5, shade: [0.5, '#393D49']});
                return false;
            }
            


            //判断活动名称不能为空
            if ($.trim($('[name="act-activity_title"]').val()) == "") {
                layer.msg('活动名称不能为空！', {icon: 5, shade: [0.5, '#393D49'], time:1200});
                return false;
            }

            //判断剩余奖品数量不能大于奖品数量
            var check_compare_reset_num = true;
            $('[data-name="rest_prize_num"]:visible').each(function () {
                var tmp_val = $(this).parent().prev().find('[data-name="prize_num"]').val();
                if (Number(tmp_val) < Number($(this).val())) {
                    check_compare_reset_num = false;
                }
            });

            //判断奖品剩余份数不能大于奖品份数
            if (! check_compare_reset_num) {
                layer.msg('奖品剩余份数不能大于奖品份数！', {icon: 5, shade: [0.5, '#393D49'], time:1200});
                return false;
            }


            //判断正数和数字合法性
            var check_positive = true;
            var check_intval = true;
            var check_number_val_null = true;
            var check_prize_name_null = true;
            $('.positive_val,.rate_num:visible').each(function (i) {
                var tmp_val = Number(this.value);
                if (tmp_val < 0) {
                    check_positive = false;
                }
                if (isNaN(tmp_val)) {
                    check_intval = false;
                }
                if ($.trim(this.value) == "") {
                    check_number_val_null = false;
                }
            });
            //判断奖品数量、剩余数量是否均为正数
            if (! check_positive) {
                layer.msg('奖品份数/剩余奖品份数/中奖率不能为负数！', {icon: 5, shade: [0.5, '#393D49'], time:1200});
                return false;
            }
            //判断奖品数量、剩余数量是否均为数字
            if (! check_intval) {
                layer.msg('奖品份数/剩余奖品份数/中奖率不能为非数字！', {icon: 5, shade: [0.5, '#393D49'], time:1200});
                return false;
            }
            if (! check_prize_name_null) {
                layer.msg('奖品份数/剩余奖品份数/中奖率不能为空！', {icon: 5, shade: [0.5, '#393D49'], time:1200});
                return false;
            }

            //判断奖品名称不能为空
            $('[data-name="name"]:visible').each(function () {
                if ($.trim(this.value) == "") {
                    check_prize_name_null = false;
                }
            });
            if (! check_prize_name_null) {
                layer.msg('奖品名称不能为空！', {icon: 5, shade: [0.5, '#393D49'], time:1200});
                return false;
            }

            var rate_count_num = 0;
            var check_rate_num_decimal = true;
            $('.rate_num:visible').each(function () {
                //判断中奖保留两位小数
                if (this.value.split('.')[1] !== undefined && this.value.split('.')[1].length > 2) {
                    check_rate_num_decimal = false;
                }

                //保留两位小数，所以此处做乘100处理，避免浮点数运算失真问题
                rate_count_num += (this.value) * 100;
            });

            if (! check_rate_num_decimal) {
                layer.msg('中奖率只能保留2位小数！', {icon: 5, shade: [0.5, '#393D49'], time:1200});
                return false;
            }

            rate_count_num /= 100;
            if (rate_count_num != 100) {
                layer.msg('所有奖品中奖率之和不等于100(当前值为' + rate_count_num + ')！', {icon: 5, shade: [0.5, '#393D49'], time:1200});
                return false;
            }

            var update_id = $(this).data('id');

            //初始化数据对象
            var post_data_obj = {};
            post_data_obj['id'] = update_id;

            //开始结束时间
            post_data_obj['start_time'] = $('[name="act-start_time"]').val();
            post_data_obj['end_time'] = $('[name="act-end_time"]').val();

            //活动详情和活动声明
            post_data_obj['activity_details'] = $('[name="act-activity_details"]').val();
            post_data_obj['activity_statement'] = $('[name="act-activity_statement"]').val();

            //标题、活动是否正在进行中
            post_data_obj['activity_title'] = $('[name="act-activity_title"]').val();
            post_data_obj['is_underway'] = $('[name="act-is_underway"]').val();

            if( "{$view_type}" == "1") {
                //新增时，需要选择转盘图片
                var view_type = '{$view_type}';
                post_data_obj['view_type'] = view_type;
                post_data_obj['turn_num'] = $('.select_turn_num').val();
                post_data_obj['turn_pic'] = $('[data-img-key]:visible').attr('src');
            }


            //玩法规则处理
            var rules_obj = {};
            $('.rules:enabled').each(function () {
                var $this = $(this), 
                    data_key = $this.data('key');
                rules_obj[data_key] = $this.val();
            });
            post_data_obj['rules_json'] = rules_obj;


            //层级限制的用户组
            var group_check_arr = [];
            $('.group_check:checked').each(function (i) {
                group_check_arr[i] = $(this).val();
            });
            post_data_obj['user_group_limit'] = group_check_arr.join(',');

            //奖品设置
            var prize_arr = [];
            $('.prize_setting_tb>tr:visible').find('[data-prize-flag]').each(function () {
                var $this = $(this);
                var index = $this.data('index');
                if (typeof prize_arr[index] === 'undefined') {
                    prize_arr[index] = {};
                }
                prize_arr[index][$this.attr('data-name')] = $this.val();
            });
            post_data_obj['activity_setting_json'] = prize_arr;

            if (post_data_obj['is_underway'] == '0') {
                activity_save(post_data_obj);

            } else if (post_data_obj['is_underway'] == '1') {
                //拼接活动规则字串
                var txt_obj = {
                    'every_topup' : '<p>每充值达到',// '元，可以玩', '次'],
                    'every_bet' :   '<p>每投注达到',// '元，可以玩', '次'],
                    'every_win' :   '<p>每赢达到',// '元，可以玩', '次'],
                    'every_lose' :  '<p>每输达到',// '元，可以玩', '次'],
                };
                var $all_p = $('.rules_setting > p'),
                    each_val,
                    each_val2,
                    i = 0,
                    rules_arr = [];
                for (var obj_k in txt_obj) {
                    each_val = $all_p.find('[data-key="' + obj_k + '"]').val();
                    each_val2 = $all_p.find('[data-key="' + obj_k + '_val"]').val();
                    if (each_val > 0) {
                        rules_arr[i++] = txt_obj[obj_k] + each_val + '元，可以玩' + each_val2 + '次</p>';
                    }
                }

                //拼接奖项字串
                var award_arr = [];
                $('.prize_setting_tb').find('[data-award-tips]').each(function (idx) {
                    award_arr[idx] = [
                        '<p>【', $(this).data('award-tips'), '】项为：', $(this).val(), '</p>',
                    ].join('');
                });

                var sure_html = [
                    '<p>活动时间：<br>', $('.start_time').val(), ' ~ ', $('.end_time').val(), '</p>',
                    '<p>活动规则：', rules_arr.join(''), '</p>',
                    '<p>奖项：', award_arr.join(''), '</p>',
                    '<p class="sure_tips">注意：活动开启后，不可修改，只能停止该活动后，重新开启新的活动。确定保存该活动为开启状态？</p>',
                ].join('');
                layer.confirm(sure_html, {title:'确认活动信息'}, function(layer_index){
                    activity_save(post_data_obj);
                    layer.close(layer_index);
                });

            } else if (post_data_obj['is_underway'] == '2') {
                var sure_html = [
                    '<p class="sure_tips">注意：活动停止后，不可修改。确定保存该活动为停止状态？</p>',
                ].join('');
                layer.confirm(sure_html, {title:'确认活动信息'}, function(layer_index){
                    activity_save(post_data_obj);
                    layer.close(layer_index);
                });
            }
        });
    });

    function activity_save (post_data_obj) {
        console.log(post_data_obj);
        //等待层
        var loading;

        //提交
        $.ajax({
            url: '?m=admin&c=turntable&a=activity_save',
            data: post_data_obj,
            dataType: 'json',
            type: 'post',
            beforeSend: function () {
                loading = layer.load(1);
            },
            error: function () {
                layer.close(loading);
                layer.msg('参数错误或网络异常！！！', {icon: 5, shade: [0.5, '#393D49']});
            },
            success: function (result) {
                layer.close(loading);
                if (result.rt) {
                    layer.msg('操作成功！！！', {icon: 6, shade: [0.5, '#393D49']}, function () {
                        location.href='?m=admin&c=turntable&a=activity_list'
                        // alert('ok');
                        // location.reload();
                    });
                } else {
                    layer.msg(result.msg, {icon: 5, shade: [0.5, '#393D49']});
                }
            }
        });
    }


    // $(function(){
    //     $(".turn_num").trigger("change");
    // })
    // $("input[name='prize_num']").bind("blur",function(){
    //     var obj = $(this);
    //     obj.parent().next().find("input[name='rest_prize_num']").val(obj.val());
    // })
    // $(".turn_num").bind("change",function(){
    //     var type = $(".turn_num").val();
    //     if(type == 4)
    //     {
    //         $(".4-num").css("display","table");
    //         $(".6-num").css("display","none");
    //         $(".8-num").css("display","none");
    //     }
    //     else if(type == 6)
    //     {
    //         $(".4-num").css("display","none");
    //         $(".6-num").css("display","table");
    //         $(".8-num").css("display","none");
    //     }
    //     else if(type == 8)
    //     {
    //         $(".4-num").css("display","none");
    //         $(".6-num").css("display","none");
    //         $(".8-num").css("display","table");
    //     }
    // })
    // function getImgType(type)
    // {
    //     if(type == 1)
    //     {
    //         $(".upload_img").css("display","block");
    //         $(".template").css("display","none");
    //     }
    //     else if(type == 2 )
    //     {
    //         $(".upload_img").css("display","none");
    //         $(".template").css("display","block");

    //         $(".turn_num").bind("change",function(){
    //             var type = $(".turn_num").val();
    //             if(type == 4)
    //             {
    //                 $(".img_4").css("display","block");
    //                 $(".img_6").css("display","none");
    //                 $(".img_8").css("display","none");
    //             }
    //             else if(type == 6)
    //             {
    //                 $(".img_4").css("display","none");
    //                 $(".img_6").css("display","block");
    //                 $(".img_8").css("display","none");
    //             }
    //             else if(type == 8)
    //             {
    //                 $(".img_4").css("display","none");
    //                 $(".img_6").css("display","none");
    //                 $(".img_8").css("display","block");
    //             }
    //         });
    //         $(".turn_num").trigger("change");
    //     }
    // }


    // $(".outBtn").bind('click',function(){
    //     var type = $(".turn_num").val();
    //     var id = "{$id}";
    //     var tmp = {};
    //     tmp['activity_title'] = $($(".activity").children()[0]).find("input[name='activity_title']").val();//活动名称
    //     tmp['start_time'] = $($(".activity").children()[1]).find("input[name='first_time']").val();//开始时间
    //     tmp['end_time'] = $($(".activity").children()[1]).find("input[name='last_time']").val();//结束时间
    //     tmp['states'] = $($(".activity").children()[2]).find("input[name='states']:checked").val();//是否开启
    //     tmp['consume'] = $($(".activity").children()[3]).find("input[name='consume']").val();//消耗积分
    //     tmp['turn_num'] = $($(".activity").children()[4]).find("select[name='turn_num']").val();//转盘格数
    //     tmp['pic_path'] = "";
    //     if($(".upload_img").is(':hidden') === false)//true 隐藏 false 显示
    //     {
    //         tmp['pic_path'] = $($(".activity").children()[5]).find(".upload_img").find("input[name='pic_path']").val();//转盘图片
    //     }
    //     else if($(".template").is(':hidden') === false)
    //     {
    //         if(type == 4)
    //         {
    //             tmp['pic_path'] =  $($(".activity").children()[5]).find(".template").find(".img_4").find("input[name='pic_path']").val();
    //         }
    //         else if(type == 6)
    //         {
    //             tmp['pic_path'] =  $($(".activity").children()[5]).find(".template").find(".img_6").find("input[name='pic_path']").val();
    //         }
    //         else if(type == 8)
    //         {
    //             tmp['pic_path'] =  $($(".activity").children()[5]).find(".template").find(".img_8").find("input[name='pic_path']").val();
    //         }
    //     }

    //     tmp['activity_id'] = id;
    //     var reg = /^[0-9A-Za-z_\u4e00-\u9fa5]{2,15}$/;
    //     var reg_num = /^[0-9]*$/;
    //     if(tmp['activity_title'] == "" || !reg.test(tmp['activity_title']))
    //     {
    //         layer.alert("活动名称只能输入字母，数字，下划线以及中文,长度2-15个字符并且不能为空");
    //         return false;
    //     }

    //     if(!reg_num.test(tmp['consume']) || tmp['consume'] == "")
    //     {
    //         layer.alert("消耗积分只能输入正整数,且不能为空");
    //         return false;
    //     }
    //     if( tmp['pic_path'] == "")
    //     {
    //         layer.alert("请上传转盘图片");
    //         return false;
    //     }

    //     var data = []
    //     if(id == "")
    //     {
    //         if(type == 4)
    //         {
    //             var obj = $(".4-prize-body").children();
    //         }
    //         else if(type == 6)
    //         {
    //             var obj = $(".6-prize-body").children();
    //         }
    //         else if(type == 8)
    //         {
    //             var obj = $(".8-prize-body").children();
    //         }
    //     }
    //     else
    //     {
    //         var obj = $(".prize-body").children();
    //     }

    //     var titleInfo = [];
    //     var idInfo = [];
    //     for(var i = 0; i < obj.length; i ++)
    //     {
    //         var newTmp = {};
    //         var stroke = [];
    //         newTmp['id'] = $(obj[i]).find("input[name='id']").val();//奖品序号
    //         newTmp['title'] = $(obj[i]).find("input[name='title']").val();//奖品名称
    //         newTmp['num'] = $(obj[i]).find("input[name='num']").val();//积分/元宝数值
    //         newTmp['prize_num'] = $(obj[i]).find("input[name='prize_num']").val();//奖品数量
    //         newTmp['rest_prize_num'] = $(obj[i]).find("input[name='rest_prize_num']").val();//剩下奖品数量
    //         newTmp['white_list'] = $(obj[i]).find("input[name='white_list']").val();//白名单
    //         newTmp['prize_type'] = $(obj[i]).find("select[name='prize_type']").val();//奖品类型
    //         newTmp['is_prizes'] = $(obj[i]).find("select[name='is_prizes']").val();//是否为奖品
    //         if(newTmp['title'] == "" || !reg.test(newTmp['title']))
    //         {
    //             layer.alert("奖品名称只能输入字母，数字，下划线以及中文,长度2-15个字符并且不能为空");
    //             return false;
    //         }

    //         if($.inArray(newTmp['id'], idInfo) !== -1)
    //         {
    //             layer.alert("奖品序号重复1");
    //             return false;
    //         }
    //         idInfo.push(newTmp['id']);
    //         if(!reg_num.test(newTmp['id']))
    //         {
    //             layer.alert("奖品序号输入有误");
    //             return false;
    //         }



    //         if($.inArray(newTmp['title'], titleInfo) !== -1)
    //         {
    //             layer.alert("奖品名称重复");
    //             return false;
    //         }
    //         titleInfo.push(newTmp['title']);

    //         if(newTmp['prize_type'] != 1)
    //         {
    //             if(newTmp['num'] == "" || !reg_num.test(newTmp['num']))
    //             {
    //                 layer.alert("奖品积分/元宝数额必须是正整数并且不能为空");
    //                 return false;
    //             }
    //         }
    //         if( newTmp['prize_num'] == "" || !reg_num.test(newTmp['prize_num']))
    //         {
    //             layer.alert("奖品份数必须是正整数并且不能为空");
    //             return false;
    //         }

    //         if(  newTmp['rest_prize_num'] == "" || !reg_num.test( newTmp['rest_prize_num']))
    //         {
    //             layer.alert("剩余奖品份数必须是正整数,且不能为空");
    //             return false;
    //         }


    //         var white_ist_reg = /^[0-9A-Za-z_-]*$/;
    //         if(newTmp['white_list'] != "")
    //         {
    //             var xxx = 0;
    //             var arr = newTmp['white_list'].split(';');
    //             for(var a=0;a<arr.length;a++)
    //             {
    //                 if(!white_ist_reg.test(arr[a]) || arr[a].indexOf("-") < 0)
    //                 {
    //                     layer.alert("中奖白名单格式不正确");
    //                     return false;
    //                 }
    //             }
    //         }
    //         var strokeObj = $(obj[i]).find("input[name='stroke']");
    //         for(var x = 0; x < strokeObj.length; x++)
    //         {
    //             var tmps = {}
    //             tmps['user_group'] = $(strokeObj[x]).attr("data-user-group");
    //             tmps['group_name'] = $(strokeObj[x]).attr("data-group-name");
    //             tmps['stroke'] = $(strokeObj[x]).val();
    //             if(tmps['stroke'] < 0 || tmps['stroke'] == "" || !reg_num.test(tmps['stroke']) || tmps['stroke'] > 100)
    //             {
    //                 layer.alert("中奖率不能为空,取值范围：0-100");
    //                 return false;
    //             }
    //             stroke.push(tmps);
    //         }
    //         newTmp['stroke'] = stroke//中奖率
    //         newTmp['img'] =$(obj[i]).find("input[name='imgs']").val();//奖品图片
    //        // newTmp['thumb_img_msg'] =$('.imgss2').val()
    //         data.push(newTmp);

    //        // data.push($('.imgss1').val(),$('.imgss2').val());
    //     }
    //     tmp['config_value'] = data;
    //     var type = $(this).attr("data-type");
    //     var url = '';
    //     if(type == "add")
    //     {
    //         url = "{:U('LuckyTurnTable/add')}"
    //     }
    //     else if(type == "updata")
    //     {
    //         url = "{:U('LuckyTurnTable/edit')}";
    //         tmp['pic_path'] = $($(".activity").children()[5]).find("input[name='pic_path']").val();
    //     }
    //     $.ajax({
    //         url : url,
    //         type : 'POST',
    //         data : tmp,
    //         dataType:"json",
    //         beforeSend:function(){
    //             $(".outBtn").html("<i class='loading'></i>")
    //             $(".outBtn").attr("disabled",true);
    //         },
    //         success: function(data){
    //             if(data['info'] != null)
    //             {
    //                 window.parent.window.layer.msg(data['info'],{icon: 5, time:1000},function(){
    //                     window.location.reload();//刷新当前页面.
    //                 });
    //                 return;
    //             }
    //             var obj = JSON.parse(data);
    //             console.log(obj)
    //             var url = "{:U('LuckyTurnTable/index')}";

    //             if(obj['code'] == 0) {
    //                 layer.msg(obj['msg'],{icon: 1, time:1000},function(){window.location.href = url ;});
    //             } else {
    //                 layer.alert(obj['msg']);
    //             }
    //         },
    //         complete:function(){
    //             $(".outBtn").html("提交")
    //             $(".outBtn").attr("disabled",false);
    //         }
    //     });



    // })
    // function addTr(obj,className)
    // {
    //     var newObj = $(obj);
    //     $("."+className+"").append(newObj.parent().parent().clone());
    // }
    // function delTr(obj,className)
    // {
    //     if($("."+className+"").children("tr").length > 1)
    //     {
    //         $(obj).parent().parent().remove();
    //     }
    // }
    // function addAction(obj){
    //     var obj = $(obj);
    //     obj.next().html("未上传文件");
    //     var formData = new FormData();
    //     formData.append("file",obj.siblings(".upload")[0].files[0]);
    //     $.ajax({
    //         url : "{:U('LuckyTurnTable/uploadFile')}",
    //         type : 'POST',
    //         data : formData,
    //         processData : false,
    //         contentType : false,
    //         beforeSend:function(){
    //             obj.next().html("正在进行，请稍候");
    //             obj.attr("disabled",true);
    //         },
    //         success : function(responseStr) {
    //             var data = JSON.parse(responseStr);
    //             console.log(data);
    //             if(data.code == 0)
    //             {
    //                 obj.siblings("input[name='pic_path']").val(data.msg)
    //                 obj.next().html("已上传").css("color","green");
    //             }
    //             else
    //             {
    //                 obj.next().html(data.msg).css("color","red");
    //                 obj.attr("disabled",false);
    //             }
    //         },
    //         error : function(responseStr) {
    //             obj.next().html(responseStr.responseText).css("color","red");
    //         }
    //     });
    // };

    // function addimg(obj){
    //     var obj = $(obj);

    //     obj.next().html("未上传文件");
    //     var formData = new FormData();
    //     formData.append("file",obj.siblings(".imgs").context.files[0]);
    //     console.log(formData);
    //     $.ajax({
    //         url : "{:U('LuckyTurnTable/uploadFile2')}",
    //         type : 'POST',
    //         data : formData,
    //         processData : false,
    //         contentType : false,
    //         beforeSend:function(){
    //             obj.next().html("正在进行，请稍候");
    //             obj.attr("disabled",true);
    //         },
    //         success : function(responseStr) {
    //             var data = JSON.parse(responseStr);
    //             console.log(data);
    //             if(data.code == 0)
    //             {
    //                 obj.siblings("input[name='pic_path']").val(data.msg);
    //                 obj.next().html("已上传").css("color","green");
    //                 obj.siblings("input[name=imgs]").val(data.msg.thumb_img_msg)
    //                // $(".imgss1").val(data.msg.msg);
    //                // $(".imgss2").val(data.msg.thumb_img_msg);
    //             }
    //             else
    //             {
    //                 obj.next().html(data.msg).css("color","red");
    //                 obj.attr("disabled",false);
    //             }
    //         },
    //         error : function(responseStr) {
    //             obj.next().html(responseStr.responseText).css("color","red");
    //         }
    //     });
    // };

</script>
</html>
