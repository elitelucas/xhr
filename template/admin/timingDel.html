<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta name="renderer" content="webkit">
        <link rel="stylesheet" href="statics/admin/css/pintuer.css">
        <link rel="stylesheet" href="statics/admin/css/admin.css">
        <script src="statics/admin/js/jquery.js"></script>
        <!-- <script src="statics/admin/js/jquery.min.js" type="text/javascript"></script> -->
        <script src="statics/admin/js/pintuer.js"></script>  
        <script src="statics/admin/js/layer/2.1/layer.js"></script>
        <link rel="stylesheet" href="statics/admin/jedate/skin/jedate.css">
        <script type="text/javascript" src="statics/admin/jedate/jquery.jedate.min.js"></script>
        {template public-new-ui-header}
    </head>
    <body class="new_ui_body">
    <div class="ibox float-e-margins">
	    <div class="ibox-title iboxWTitle">
	        <h5>定时清除数据配置</h5>
	    </div>
	    <div class="ibox-content bagCol">
	        <div class="ibox-title ">
	            <h5>定时清除配置信息</h5>
	        </div>
	        <div class="ibox-content m-b" style="width: 100%;">
	            <form id='form_update' method="post" class="form-horizontal">
	            	<input type="hidden" value="{$data["lasttime"]}" id="lasttime"/>
	            	<div class="form-group">
	                    <label class="col-sm-2 control-label">是否开启定时清除操作</label>
	                    <div class="col-sm-2">
                       		<select class="form-control m-b" id='isopen' name="isopen">
	                           	<option value="0">开启</option>
                                <option value="1">关闭</option>
	                        </select>
                       		<span class="help-block m-b-none"></span>
	                    </div>
	                </div>
	                <div class="hr-line-dashed"></div>
	                <div class="form-group">
	                    <label class="col-sm-2 control-label">连续未登录时间</label>
	                    <div class="col-sm-2">
	                        <select class="form-control m-b" id='loginDay' name="loginDay">
	                           	<option value="3" {if $data["loginDay"] == 3} select {/if}>30天</option>
	                           	<option value="6" {if $data["loginDay"] == 6} select {/if}>60天</option>
	                           	<option value="9" {if $data["loginDay"] == 9} select {/if}>90天</option>
	                        </select>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
	                <div class="form-group">
	                    <label class="col-sm-2 control-label">是否从未充值</label>
	                    <div class="col-sm-1">
	                        <select class="form-control m-b" id='chongzhi' name="chongzhi">
	                           	<option value="1" {if $data["chongzhi"] == 1} select {/if}>是</option>
	                           	<option value="0" {if $data["chongzhi"] != 1} select {/if}>否</option>
	                        </select>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
	                <div class="form-group">
	                    <label class="col-sm-2 control-label">是否清除当前余额为零</label>
	                    <div class="col-sm-1">
	                        <select class="form-control m-b" id='yue' name="yue">
	                           	<option value="1" {if $data["yue"] == 1} select {/if}>是</option>
	                           	<option value="0" {if $data["yue"] != 1} select {/if}>否</option>
	                        </select>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
	                <div class="form-group">
	                    <label class="col-sm-2 control-label">是否清除未绑定银行卡</label>
	                    <div class="col-sm-1">
	                        <select class="form-control m-b" id='yinhangka' name="yinhangka">
	                           	<option value="1" {if $data["yinhangka"] == 1} select {/if}>是</option>
	                           	<option value="0" {if $data["yinhangka"] != 1} select {/if}>否</option>
	                        </select>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
	                <div class="form-group">
	                    <label class="col-sm-2 control-label">间隔多长时间执行一次</label>
	                    <div class="col-sm-1">
	                        <select class="form-control m-b" id='ope_time' name="ope_time">
	                           	<option value="1" {if $data["ope_time"] == 1} select {/if}>是</option>
	                           	<option value="0" {if $data["ope_time"] != 1} select {/if}>否</option>
	                        </select>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
	                <div class="form-group">
	                    <label class="col-sm-2 control-label">是否立即执行一次</label>
	                    <div class="col-sm-6">
	                    	<span class="col-sm-2" style="padding-left: 0px;">
		                        <select class="form-control m-b" id='immediately' name="immediately">
		                           	<option value="1" {if $data["yinhangka"] == 1} select {/if}>是</option>
		                           	<option value="0" {if $data["yinhangka"] != 1} select {/if}>否</option>
		                        </select>
	                        </span>
	                        <span class="col-sm-7 help-block m-b-none">（选择"是"时，保存设置信息后，会立刻执行一次清除操作）</span>
                        </div>
                    </div>
                    <div class="hr-line-dashed"></div>
	                <div class="form-group">
	                    <label class="col-sm-2 control-label">删除距今多长时间注册的用户</label>
	                    <div class="col-sm-2">
	                        <select class="form-control m-b" id='yueshu' name="yueshu">
	                           	<option value="3" {if $data["loginDay"] == 3} select {/if}>30天</option>
	                           	<option value="6" {if $data["loginDay"] == 6} select {/if}>60天</option>
	                           	<option value="9" {if $data["loginDay"] == 9} select {/if}>90天</option>
	                        </select>
                        </div>
                    </div>
                </form>
                <div class="form-group">
	            	<div class="col-sm-4 col-sm-offset-2">
	                	<button class="btn btn-primary" type="submit" id="btn_submit" onclick="baocun()">保存</button>
	            	</div>
       			</div>
            </div>
            
            <div class="ibox-title ">
	            <h5>清除订单数据</h5>
	        </div>
	        <div class="ibox-content m-b" style="width: 100%;">
	            <form id='form_update' method="post" class="form-horizontal">
	            	<input type="hidden" value="{$data["lasttime"]}" id="lasttime"/>
	            	<div class="form-group">
	                    <div class="col-sm-7" style="margin-left: 10px;text-align: left;width: 100%;">
                            <label style="color: #f50e39">提示：删除之后无法恢复,请谨慎操作！！！</label>
                        </div>
	                </div>
	                <div class="hr-line-dashed"></div>
	                <div class="form-group">
	                    <label class="col-sm-2 control-label">时间</label>
	                    <div class="col-sm-2">
	                        <input name="start_time" class="date_picker form-control" id="datePicker" value="{$_REQUEST['start_time']}"/>
                        </div>
                    </div>
                 </form>
                 <div class="form-group">
	            	<div class="col-sm-4 col-sm-offset-2">
	                	<button class="btn btn-primary" type="submit" id="btn_submit" onclick="check()">确定清除该月数据</button>
	            	</div>
       			</div>
             </div>
        </div>
    </div>
        <script>
        function baocun(){
        	var lasttime=$("#lasttime").val();
        	var yueshu=$('#yueshu').val();
        	var immediately = $('#immediately').val();
        	var ope_time=$('#ope_time').val();
        	var loginDay=$('#loginDay').val();
        	var isopen=$('#isopen').val();
        	var chongzhi=$('#chongzhi').val();
        	var yue=$('#yue').val();
        	var yinhangka=$('#yinhangka').val();
        	
        	if (immediately == 1) {
        		layer.confirm('修改清除配置后，确定立即执行清除操作，清除后数据无法恢复,请谨慎操作!', {
                    btn: ['确定','取消'] //按钮
                }, function(){
	            	$.ajax({
	                    type: 'GET',
	                    url: '?m=admin&c=role&a=timingDelDb&loginDay=' + loginDay+ '&immediately=' + immediately + '&lasttime='+lasttime+'&yueshu='+yueshu+'&ope_time='+ope_time+'&chongzhi='+chongzhi+'&yue='+yue+'&yinhangka='+yinhangka+'&isopen='+isopen,
	                    success: function (msg) {
	                        if (msg) {
	                            layer.msg('设置成功!', {icon: 6, shade: [0.5, '#393D49']});
	                        } else {
	                            layer.msg('设置失败!', {icon: 5, shade: [0.5, '#393D49']});
	                        }
	                    }
	                });
	        	});
        	}else {
        		$.ajax({
                    type: 'GET',
                    url: '?m=admin&c=role&a=timingDelDb&loginDay=' + loginDay+ '&immediately=' + immediately + '&lasttime='+lasttime+'&yueshu='+yueshu+'&ope_time='+ope_time+'&chongzhi='+chongzhi+'&yue='+yue+'&yinhangka='+yinhangka+'&isopen='+isopen,
                    success: function (msg) {
                        if (msg) {
                            layer.msg('设置成功!', {icon: 6, shade: [0.5, '#393D49']});
                        } else {
                            layer.msg('设置失败!', {icon: 5, shade: [0.5, '#393D49']});
                        }
                    }
                });
        	}
        }

        $(function () {
            //时间插件
            $(".date_picker").jeDate({
                isinitVal:true,
                festival:true,
                ishmsVal:true,
                minDate: '2016-01-01',
                maxDate: $.nowDate(0),
                format:"YYYY-MM",
                zIndex:3000,
            })
        })
        function check() {
            layer.confirm('删除之后无法恢复,请谨慎操作!!!', {
                btn: ['确定删除','取消删除'] //按钮
            }, function(){
                var start_time = $("input[name=start_time]").val();
                if (start_time == "") {
                    layer.msg('时间不能为空!!!', {icon: 5, shade: [0.5, '#393D49']});
                    return false;
                }

                var myDate = new Date();
                //获取当前年
                var year = myDate.getFullYear();
                //获取当前月
                var month = myDate.getMonth() + 1;
                //获取当前日
                var date = myDate.getDate();
                var now = year + '-' + p(month);
                console.log(now);
                if (start_time > now) {
                    layer.msg('时间不能大于本月日期!!!', {icon: 5, shade: [0.5, '#393D49']});
                    return false;
                }
                $.ajax({
                    type: "POST",
                    url: "<?=url('admin','role','delOrders')?>",
                    data: {'start_time':start_time},
                    beforeSend:function(){
                        loading = layer.load(0);
                    },
                    success: function(msg){
                        layer.close(loading);
                        msg = JSON.parse(msg);
                        console.log(msg.msg);
                        if(msg.status){
                            layer.msg(msg.msg, {icon: 6, shade: [0.5, '#393D49']});
                        }else {
                            layer.msg(msg.msg, {icon: 5, shade: [0.5, '#393D49']});
                        }
                    }
                });
            }, function(){
                return true;
            });

        }

        /**
         *
         * 获取当前时间
         */
        function p(s) {
            return s < 10 ? '0' + s : s;
        }
        </script>
    </body>
</html>